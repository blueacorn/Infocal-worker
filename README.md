# Infocal worker

A serverless application to collect anonymized product usage metrics for
Garmin Connect Apps.

This application was written to provide better anonymized product usage metrics
than the very limited stats Garmin App store provides to developers.

This application uses Cloudflare "Worker" compute and "D1 SQL" database storage.
Cloudflare Worker and D1 are ideal for light telemetry, with up to 100,000 writes
a day free, and competitive pricing beyond the free tier ($5/mnth for 50 million writes/month).

## Features

- **Heartbeat tracking** (`/heartbeat`)
  Devices report in with device ID, type, version, etc.
- **Active count** (`/count`)
  Returns number of active devices in the last N seconds, with JSON or CSV output.
- **Metrics** (`/metrics`)
  Analytics query to provide usage metrics grouped by any/multiple dimension(s).
  Groups devices by one or more fields (`part_num`, `fw_version`, `sw_version`, `country`) with JSON or CSV output.
- **Device list** (`/list`)
  Diagnostic to list all active devices, with JSON or CSV output.
- **Authentication**
  - **Client token** (`X-Auth`) → required for client devices to send `/heartbeat`.
  - **Admin token** (`X-Auth`) → required for analytics `/count`, `/list`, `/metrics`.
- **GDPR-compliant**
  - Provides country-level aggregation; does not store any personally-identifiable information,
- **Cache control**
  All responses are served with `Cache-Control: no-store, no-cache, must-revalidate`
  to help ensure queries never get served stale data by any intermediary proxies.

---

## Project structure
src/worker.ts       # Cloudflare worker implementation
wrangler.jsonc      # Cloudflare Wrangler config
schema.sql          # SQL schema
README.md

## Database schema
see schema.sql

---

# Usage
This worker can be deployed to any Cloudflare account; follow the instructions below
to clone/fork and use this serverless application with your Garmin apps.

## Prerequisites

- Node.js
        brew install npm

- Cloudflare Wrangler CLI
        npm install -g wrangler


## Local Deployment (for testing/development)

        # Login to your Cloudflare account
        wrangler login

        # create a local copy of database
        wrangler d1 execute infocal-db --file=./schema.sql

        # start the worker (api endpoint http://localhost:8787)
        wrangler dev --env dev


Note for testing, we use env.dev to pre-configure the test environment.
See wrangler.jsonc for details of setup.

## Production Deployment

        # Login to your Cloudflare account
        wrangler login

        # Create the remote (production) database
        wrangler d1 execute infocal-db --file=./schema.sql --remote

        # Set your production secrets in the cloudflare secrets manager
        wrangler secret put CLIENT_TOKEN
        wrangler secret put ADMIN_TOKEN

        # Deploy your code
        wrangler deploy


## Development & Testing

## Setup Test Environment

### Local testing
```sh
export URL=http://localhost:8787
export CLIENT_TOKEN=dev-client-token
export ADMIN_TOKEN=dev-admin-token
```

### Production endpoint testing

```sh
export URL=https://infocal-worker.<your cloudflare subdomain>.workers.dev
export CLIENT_TOKEN=<your client secret>
export ADMIN_TOKEN=<your admin secret>
```

### Heartbeat endpoint

Simulate a client device sending a heartbeat:

```sh
curl -X POST "$URL/heartbeat?uid=test-123&part_num=F965&fw_version=15.23" -H "X-Auth: $CLIENT_TOKEN"

# response:
{ "ok": true, "lastSeen": 1725408000 }
```

### Active Devices Count endpoint

Count the number of active devices in the last (window) seconds:

```sh
curl "$URL$/count?window=3600" -H "X-Auth: $ADMIN_TOKEN"

# response(JSON):
{ "timestamp": 1725408060, "window": 3600, "active": 123 }
```

```sh
curl "$URL$/count?window=3600&format=csv" -H "X-Auth: $ADMIN_TOKEN"

# response(CSV):
timestamp,window,active
1725408060,3600,123
```

##### Metrics (analytics) endpoint

Provide summary of usage, grouped by any dimension

```sh
curl "$URL/metrics?window=86400&groups=country,sw_version&format=csv" -H "X-Auth: $ADMIN_TOKEN"

# response(CSV)
country,sw_version,count
CA,2025.8.16,30
CA,2025.8.21,55
US,2025.8.16,2
US,2025.8.17,5
...
```

#### List (debugging) endpoint

List raw table output (for debugging):

```sh
curl "$URL$/list?window=600&format=csv" -H "X-Auth: $ADMIN_TOKEN"

# response(CSV):
unique_id,first_seen,last_seen,part_num,fw_version,sw_version,country
d0983fdas,1725408000,1725408060,vivoactive,15.23,Unknown,CA
8moiuasf7,1725312456,1725398909,fenix8,10.5,2025.8.0,CA
...
```

---

## Development tips

### Inspect table schema

```sh
wrangler d1 execute infocal-db --command "PRAGMA table_info(heartbeats);" [--local|--remote]
```

### Tail logs for debugging

Used to 'tail' the log file generated by the production worker:

```sh
wrangler tail infocal-worker
```

---

# Privacy & GDPR
*	Device telemetry stored: unique_id, part_num, fw_version, sw_version, country.
*	IP addresses are never stored.
*	All data is retained only as long as necessary for anonymized product usage analysis, product health monitoring, and service development.

